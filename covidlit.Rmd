---
title: "COVID19 literature"
output:
  html_document:
    df_print: paged
---


```{r}
library(tidyverse)
library(tidyr)
```

Load in data from the NIH COVID-19 portfolio (https://icite.od.nih.gov/covid19/search/).
```{r}
covidlit <- read_csv('~/Downloads/covidlit-COVID-19_Portfolio-export_2020-05-30-2-06-55.csv')
```
Let's check out the columns we have...
```{r}
spec(covidlit)
```

How many total articles?
```{r}
nrow(covidlit)
```

Select the columns we want...
```{r}
covidlit <- covidlit %>% select(c("DOI","PMCID","PMID","Publication Date", "Publication Types", "Source", "Journal Name"))
```

We want to count published articles and preprints. What kind of sources do we have?
```{r}
unique(covidlit$Source)
```
Let's count articles by type...
```{r}
for (src in unique(covidlit$Source)) {
  print(paste(src, nrow(covidlit[covidlit$Source == src,])))
}
```
For each date in the 'Publication Date' column, count number of articles and number of preprints...
```{r}
# convert 'Publication Date' to a Date field
covidlit$`Publication Date` <- as.Date(covidlit$`Publication Date`, format = "%Y-%m-%d")
dates <- sort(unique(as.Date(covidlit$`Publication Date`)))
# data.frame to hold the data
df <- data.frame(date = NA, total = NA, jrnl = NA, pp = NA, stringsAsFactors = FALSE)
for (d in as.list(dates)) {
  tmp <- covidlit[covidlit$`Publication Date` == d,]
#  print (paste(as.Date(d, format="%Y-%m-%d"), 
#               nrow(tmp),
#               nrow(tmp[tmp$Source == 'Peer reviewed (PubMed)',]),
#               nrow(tmp[tmp$Source %in% c("ChemRxiv", "Research Square", "bioRxiv", "medRxiv",
#                                          "SSRN", "arXiv"),])
#               ))
  df <- rbind(df, data.frame(date = d, 
                             total = nrow(tmp),
                             jrnl = nrow(tmp[tmp$Source == 'Peer reviewed (PubMed)',]),
                             pp = nrow(tmp[tmp$Source %in% c("ChemRxiv", "Research Square", "bioRxiv", "medRxiv",
                                          "SSRN", "arXiv"),]),
                             stringsAsFactors = FALSE))
}
# when creating a data.frame, dates get mangled, so reformat
df$date <- as.Date(df$date, origin="1970-01-01")
# remove the first row, all NA
df <- df[-1,]
# get cumulative # of journal articles and preprints
df$cumsum <- cumsum(df$total)
df$cumjrnl <- cumsum(df$jrnl)
df$cumpp <- cumsum(df$pp)
df
```

Make the data 'tidy'...
```{r}
# get rid of columns we don't need & filter for pubs in 2020
df <- df %>% select(-c("total", "jrnl", "pp")) %>% filter(date >= "2020-01-01")

# rename cols (note, these are cumulative totals)
colnames(df) <- c("date","All Articles", "Published", "Preprints")

# use {tidyr} to convert a 'wide' table to 'long' for easier plotting (see https://tidyr.tidyverse.org/)
mytable <- df %>% pivot_longer(cols = c('All Articles', 'Published', 'Preprints'), names_to = "Article type",
                               values_to = "count")
mytable
```

Graph the data...
```{r}
p <- ggplot(mytable) +
  geom_line(aes(x = date, y = count, color = `Article type`)) +
#  geom_col(aes(x = date, y = count, fill = `Article type`), color = 'black') +
  labs(title = "Growth of the COVID-19 literature", 
       subtitle = "Source: https://icite.od.nih.gov/covid19/search/",
       y = "Articles", x = "Date") +
  theme(legend.position = "right")

 
p
ggsave('~/tmp/covidlit.jpg')
```


When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

